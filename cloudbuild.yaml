substitutions:
  _ENV: 'dev'   # hiện không còn dùng, nhưng giữ nếu sau này cần
  _PROJECT_ID: 'project-neon-480615'
  _REGION: 'asia-southeast1'
  _REPO_NAME: 'project-neon-service-repo'
  _SERVICE_NAME: 'project-neon-service'
  _GKE_CLUSTER: 'project-neon-gke'
  _GKE_ZONE: 'asia-southeast1-a'
  _RELEASE_NAME: 'project-neon'

options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # 1) Clone repo configuration (cho Cloud Deploy dùng skaffold.yaml & manifests)
  - name: 'gcr.io/cloud-builders/git'
    id: 'Clone config repo'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        git clone https://github.com/chuonghvz/project_neon_configuration /workspace/config

  # 2) Build image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build image'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'
      - '.'

  # 3) Push image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push image'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}'
      - '--all-tags'

  # 4) Create Cloud Deploy release (dev -> uat, uat requireApproval)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Create Cloud Deploy release'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e
        cd /workspace/config

        RELEASE_NAME="project-neon-$(date +%Y%m%d-%H%M%S)-$SHORT_SHA"
        echo "Creating release $RELEASE_NAME"

        gcloud deploy releases create "$RELEASE_NAME" \
          --project=${_PROJECT_ID} \
          --region=${_REGION} \
          --delivery-pipeline=project-neon-service-pipeline \
          --skaffold-file=skaffold.yaml \
          --images=project-neon-service-image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}

images:
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'